# OSUB - Operation Subroutines

**Source Location:** `D:\ICIS\AuroDev\clogan\AuroDev\MSVC Programs\osub`

**Description:** OSUB (Operation Subroutines) provides auto-generated database access routines for MHC/MEM system tables. These routines are generated by the `p_ut_makdb` utility from XML table definitions and provide standardized CRUD (Create, Read, Update, Delete) operations for database tables.

**Note:** All OSUB files are marked as "GENERATED DO NOT MAKE ANY MODIFICATIONS WITHIN THIS FILE". Changes should be made to the source XML definitions and regenerated.

---

## Overview

OSUB routines follow a consistent pattern for each database table. Each table has:
- A structure definition (`typedef struct`)
- Standard database access functions (select, insert, update, delete, count, sum)
- Helper functions (init, copy, history)
- A static class wrapper (`db_<TABLE>`) for object-oriented access

---

## Common Functions Pattern

All OSUB table access routines follow this standard pattern:

### `TABLE_select_TABLE_PR_KEY`

**Signature:**
```cpp
long TABLE_select_TABLE_PR_KEY(TABLE *sel, GP_BOOL Update)
```

**Description:**
Selects a single record from the database table by primary key. The primary key fields must be set in the `sel` structure before calling.

**Parameters:**
- `sel` (TABLE*): Pointer to table structure. Primary key fields must be populated before call. On return, contains the selected record data.
- `Update` (GP_BOOL): If `TRUE`, locks the record for update (pessimistic locking). If `FALSE`, uses read-only lock.

**Return Values:**
- `GP.GOOD` (0): Success - record found and loaded
- `GP.BAD` (-1): Failure - record not found or database error
- `SQL.HELD` (-2): Record is locked by another process

**Logic Flow:**
1. Creates ADODB Recordset if not already created
2. Closes any open recordset
3. Builds SQL SELECT query using primary key fields from `sel`
4. Sets lock type based on `Update` parameter and transaction state
5. Opens recordset and moves to first record
6. Copies all fields from recordset to `sel` structure
7. Handles date/time field conversions using `cs_dtm_internal()` and `cs_dtm_fmt()`

**Dependencies:**
- Calls: `ds_sql_set_RsP()`, `Check_DB_Null()`, `cs_dtm_internal()`, `cs_dtm_fmt()`, `ds_check_error()`
- Tables: Database table corresponding to TABLE structure

**Usage Example:**
```cpp
SYS sys;
SYS_init(&sys);
cc_str.copy(sys.area, sizeof(sys.area), "A");

if (SYS_select_SYS_PR_KEY(&sys, GP_FALSE) == GP.GOOD) {
    // Record found, sys structure now contains data
    cs_log_printf(FILELINE, CS_LOG_INFO, "System area %s is %s", sys.area, sys.warm ? "warm" : "cold");
} else {
    cs_log_printf(FILELINE, CS_LOG_ERROR, "Failed to select SYS record for area %s", sys.area);
}
```

**Source Files:**
- `sys.cpp` (lines 25-164)
- `movs.cpp` (lines 25-174)
- `stk.cpp` (lines 25-100+)
- `load.cpp` (lines 25-100+)

---

### `TABLE_select_LOOP`

**Signature:**
```cpp
long TABLE_select_LOOP(TABLE *sel, long *count, char *where, GP_BOOL Update, int top = 0)
```

**Description:**
Selects records from the database table using a WHERE clause. Supports forward-only cursor iteration through multiple records. Can be used to select all records or a limited number (TOP N).

**Parameters:**
- `sel` (TABLE*): Pointer to table structure. On return, contains the current record data.
- `count` (long*): Pointer to record counter. Initialize to 0 before first call. Set to -1 to close the recordset. Incremented on each successful read.
- `where` (char*): SQL WHERE clause (e.g., "WHERE status = 'ACTIVE'"). Must include "WHERE" keyword.
- `Update` (GP_BOOL): If `TRUE`, uses pessimistic locking. If `FALSE`, uses read uncommitted isolation.
- `top` (int): Optional. Limits number of records returned. 0 = no limit.

**Return Values:**
- `GP.GOOD` (0): Success - record loaded
- `GP.UGLY` (-3): End of recordset - no more records
- `GP.BAD` (-1): Failure - database error

**Logic Flow:**
1. If `count == -1`, closes recordset and returns
2. Creates recordset if not exists
3. If recordset is closed, opens with WHERE clause
4. If recordset is open, moves to next record
5. Checks for EOF/BOF conditions
6. Increments count and loads record data
7. Returns `GP.UGLY` when no more records

**Dependencies:**
- Calls: `ds_sql_set_RsP()`, `ds_sql_clear_RsP()`, `Check_DB_Null()`, `cs_dtm_internal()`, `cs_dtm_fmt()`
- Tables: Database table corresponding to TABLE structure

**Usage Example:**
```cpp
MOVS movs;
MOVS_init(&movs);
long count = 0;
char where[256];
sprintf_s(where, sizeof(where), "WHERE move_status = 'PENDING' AND area = 'A'");

while (MOVS_select_LOOP(&movs, &count, where, GP_FALSE, 0) == GP.GOOD) {
    cs_log_printf(FILELINE, CS_LOG_INFO, "Move [%s] from %s to %s", 
        movs.loadid, movs.initial_location, movs.final_location);
}

// Close recordset
count = -1;
MOVS_select_LOOP(&movs, &count, where, GP_FALSE, 0);
```

**Source Files:**
- `sys.cpp` (lines 165-341)
- `movs.cpp` (lines 175-361)

---

### `TABLE_insert`

**Signature:**
```cpp
long TABLE_insert(TABLE *sel, ...)
```

**Description:**
Inserts a new record into the database table. Automatically sets `add_date`, `add_user`, `modify_date`, and `modify_user` if not already set.

**Parameters:**
- `sel` (TABLE*): Pointer to table structure containing data to insert. All required fields must be populated.

**Return Values:**
- `GP.GOOD` (0): Success - record inserted
- `GP.BAD` (-1): Failure - database error (e.g., constraint violation, duplicate key)

**Logic Flow:**
1. Sets `add_date` and `add_user` to current date/time and program name if blank
2. Sets `modify_date` and `modify_user` similarly
3. Builds parameterized INSERT SQL statement
4. Creates ADODB Command object
5. Appends all field values as parameters
6. Executes command
7. Handles date/time conversions for SQL Server format

**Dependencies:**
- Calls: `cs_dtm_current()`, `cs_dtm_fmt()`, `cs_dtm_put()`, `sscanf_s()`, `ds_check_error()`
- Tables: Database table corresponding to TABLE structure

**Usage Example:**
```cpp
MOVS movs;
MOVS_init(&movs);
cc_str.copy(movs.loadid, sizeof(movs.loadid), "L00123");
cc_str.copy(movs.area, sizeof(movs.area), "A");
cc_str.copy(movs.move_status, sizeof(movs.move_status), "PENDING");
cc_str.copy(movs.initial_location, sizeof(movs.initial_location), "STN01");
cc_str.copy(movs.final_location, sizeof(movs.final_location), "BAY01-02-03");

if (MOVS_insert(&movs) != GP.GOOD) {
    cs_log_printf(FILELINE, CS_LOG_ERROR, "Failed to insert move record for load %s", movs.loadid);
    return GP.BAD;
}
```

**Source Files:**
- `sys.cpp` (lines 342-571)
- `movs.cpp` (lines 362-651)

---

### `TABLE_update`

**Signature:**
```cpp
long TABLE_update(TABLE *sel)
long TABLE_update(TABLE *sel, char* table)
```

**Description:**
Updates the current record in the database. The record must have been previously selected using `TABLE_select_TABLE_PR_KEY` or `TABLE_select_LOOP` with `Update = TRUE`. Automatically updates `modify_date` and `modify_user`.

**Parameters:**
- `sel` (TABLE*): Pointer to table structure containing updated data. Primary key fields must match the selected record.
- `table` (char*): Optional. Specifies which table to update (for views with multiple base tables). Default is "*" (all base tables).

**Return Values:**
- `GP.GOOD` (0): Success - record updated
- `GP.BAD` (-1): Failure - database error or record not found

**Logic Flow:**
1. Sets `modify_date` to current date/time
2. Sets `modify_user` to program name (`gg_prgnam`)
3. Builds parameterized UPDATE SQL statement with WHERE clause on primary key
4. Creates ADODB Command object
5. Appends all field values as parameters
6. Executes command

**Dependencies:**
- Calls: `cs_dtm_current()`, `cs_dtm_fmt()`, `sscanf_s()`, `ds_check_error()`
- Tables: Database table corresponding to TABLE structure

**Usage Example:**
```cpp
SYS sys;
SYS_init(&sys);
cc_str.copy(sys.area, sizeof(sys.area), "A");

if (SYS_select_SYS_PR_KEY(&sys, GP_TRUE) == GP.GOOD) {
    sys.warm = 1;
    sys.auto_mode = 1;
    
    if (SYS_update(&sys) != GP.GOOD) {
        cs_log_printf(FILELINE, CS_LOG_ERROR, "Failed to update SYS record");
        return GP.BAD;
    }
}
```

**Source Files:**
- `sys.cpp` (lines 680-941)
- `movs.cpp` (lines 760-1093)

---

### `TABLE_delete`

**Signature:**
```cpp
long TABLE_delete(TABLE *sel)
```

**Description:**
Deletes the current record from the database. The record must have been previously selected with `Update = TRUE`.

**Parameters:**
- `sel` (TABLE*): Pointer to table structure. Recordset must be open and positioned on the record to delete.

**Return Values:**
- `GP.GOOD` (0): Success - record deleted
- `GP.BAD` (-1): Failure - database error or referential integrity violation

**Logic Flow:**
1. Deletes current record from open recordset using `adAffectCurrent`
2. Logs operation

**Dependencies:**
- Calls: `ds_check_error()`
- Tables: Database table corresponding to TABLE structure

**Usage Example:**
```cpp
MOVS movs;
MOVS_init(&movs);
cc_str.copy(movs.loadid, sizeof(movs.loadid), "L00123");
cc_str.copy(movs.area, sizeof(movs.area), "A");

if (MOVS_select_MOVS_PR_KEY(&movs, GP_TRUE) == GP.GOOD) {
    if (MOVS_delete(&movs) != GP.GOOD) {
        cs_log_printf(FILELINE, CS_LOG_ERROR, "Failed to delete move record");
    }
}
```

**Source Files:**
- `sys.cpp` (lines 572-607)
- `movs.cpp` (lines 652-687)

---

### `TABLE_delete_where`

**Signature:**
```cpp
long TABLE_delete_where(TABLE *sel, char *where, char *top = NULL)
```

**Description:**
Deletes multiple records from the database table using a WHERE clause.

**Parameters:**
- `sel` (TABLE*): Pointer to table structure (used for recordset management).
- `where` (char*): SQL WHERE clause (e.g., "WHERE status = 'CANCELLED'"). Must include "WHERE" keyword.
- `top` (char*): Optional. Limits number of records deleted (e.g., "TOP 10"). NULL = no limit.

**Return Values:**
- `GP.GOOD` (0): Success - records deleted
- `GP.BAD` (-1): Failure - database error

**Dependencies:**
- Calls: `ds_sql_set_RsP()`, `ds_check_error()`
- Tables: Database table corresponding to TABLE structure

**Source Files:**
- `sys.cpp` (lines 608-679)
- `movs.cpp` (lines 688-759)

---

### `TABLE_update_where`

**Signature:**
```cpp
long TABLE_update_where(TABLE *sel, char *strset, char *strwhere)
```

**Description:**
Updates multiple records in the database table using SET and WHERE clauses. Automatically appends `modify_date` and `modify_user` updates.

**Parameters:**
- `sel` (TABLE*): Pointer to table structure (used for modify_user).
- `strset` (char*): SQL SET clause (e.g., "status = 'COMPLETE'"). Can be empty string.
- `strwhere` (char*): SQL WHERE clause (e.g., "WHERE area = 'A'"). Must include "WHERE" keyword.

**Return Values:**
- `GP.GOOD` (0): Success - records updated
- `GP.BAD` (-1): Failure - database error

**Dependencies:**
- Calls: `cs_dtm_current()`, `cs_dtm_fmt()`, `cc_str.isblank()`, `ds_check_error()`
- Tables: Database table corresponding to TABLE structure

**Source Files:**
- `sys.cpp` (lines 942-1019)
- `movs.cpp` (lines 1094-1171)

---

### `TABLE_count`

**Signature:**
```cpp
long TABLE_count(TABLE *sel, long* i_count, char *where)
long TABLE_count(TABLE *sel, long* i_count, char* what, char *where)
```

**Description:**
Counts the number of records matching a WHERE clause. Supports counting all records or a specific field.

**Parameters:**
- `sel` (TABLE*): Pointer to table structure (used for recordset management).
- `i_count` (long*): Pointer to receive the count result.
- `what` (char*): Optional. Field to count (e.g., "*", "loadid"). Default is "*".
- `where` (char*): SQL WHERE clause (e.g., "WHERE area = 'A'"). Must include "WHERE" keyword.

**Return Values:**
- `GP.GOOD` (0): Success - count returned in `i_count`
- `GP.BAD` (-1): Failure - database error

**Dependencies:**
- Calls: `ds_check_error()`
- Tables: Database table corresponding to TABLE structure

**Source Files:**
- `sys.cpp` (lines 1020-1110)
- `movs.cpp` (lines 1172-1262)

---

### `TABLE_sum`

**Signature:**
```cpp
long TABLE_sum(TABLE *sel, long* i_count, char *sum, char *where)
```

**Description:**
Calculates the sum of a numeric field for records matching a WHERE clause.

**Parameters:**
- `sel` (TABLE*): Pointer to table structure (used for recordset management).
- `i_count` (long*): Pointer to receive the sum result.
- `sum` (char*): SQL expression to sum (e.g., "SUM(priority)", "SUM(load_size)").
- `where` (char*): SQL WHERE clause (e.g., "WHERE area = 'A'"). Must include "WHERE" keyword.

**Return Values:**
- `GP.GOOD` (0): Success - sum returned in `i_count`
- `GP.BAD` (-1): Failure - database error

**Dependencies:**
- Calls: `ds_check_error()`
- Tables: Database table corresponding to TABLE structure

**Source Files:**
- `sys.cpp` (lines 1111-1205)
- `movs.cpp` (lines 1263-1357)

---

### `TABLE_init`

**Signature:**
```cpp
void TABLE_init(TABLE *sel)
```

**Description:**
Initializes all fields in the table structure to default values (zeros for numeric, spaces for strings, null terminators).

**Parameters:**
- `sel` (TABLE*): Pointer to table structure to initialize.

**Return Values:**
- None (void function)

**Dependencies:**
- Calls: `cc_str.set()`

**Usage Example:**
```cpp
MOVS movs;
MOVS_init(&movs);  // All fields now initialized
```

**Source Files:**
- `sys.cpp` (lines 1206-1251)
- `movs.cpp` (lines 1358-1438)

---

### `TABLE_copy`

**Signature:**
```cpp
void TABLE_copy(TABLE *to, TABLE *from)
void TABLE_copy(TABLE *to, TABLE *from, const bool with_RSP)
```

**Description:**
Copies all fields from one table structure to another. Optionally copies the recordset pointer.

**Parameters:**
- `to` (TABLE*): Destination structure.
- `from` (TABLE*): Source structure.
- `with_RSP` (bool): Optional. If `true`, copies the `RsP` (Recordset Pointer). Default is `true`.

**Return Values:**
- None (void function)

**Dependencies:**
- Calls: `cc_str.copy()`

**Source Files:**
- `sys.cpp` (lines 1272-1311)
- `movs.cpp` (lines 1459-1511)

---

### `TABLE_history`

**Signature:**
```cpp
void TABLE_history(TABLE *sel, char* history_catagory, char* history_comment, char* history_func, long history_level)
void TABLE_history(TABLE *sel, char* history_catagory, char* history_comment, char* history_func, long history_level, long history_onoff)
```

**Description:**
Sets history tracking fields in the table structure. Used for audit logging of record changes.

**Parameters:**
- `sel` (TABLE*): Pointer to table structure.
- `history_catagory` (char*): Category of history entry.
- `history_comment` (char*): Comment describing the change.
- `history_func` (char*): Function name that made the change.
- `history_level` (long): History level/priority.
- `history_onoff` (long): Optional. History enabled flag. Default is `GP.HIST.ONOFF.ON`.

**Return Values:**
- None (void function)

**Dependencies:**
- Calls: `cc_str.copy()`

**Source Files:**
- `sys.cpp` (lines 1256-1271) - if `GOT_HISTORY` defined
- `movs.cpp` (lines 1439-1458) - if `GOT_HISTORY` defined

---

## Table-Specific Structures

### SYS Structure

**Source:** `sys.h` (lines 24-58)

**Database Table:** `MHC_SM2DB_SYS`

**Primary Key:** `area` (char[2])

**Key Fields:**
- `version_cpp` (long): C++ version number
- `area` (char[2]): System area identifier
- `warm` (long): Warm start flag
- `up` (long): System up flag
- `down` (long): System down flag
- `auto_mode` (long): Auto mode enabled
- `loglvl` (long): Logging level
- `warm_dtm` (char[24]): Warm start date/time
- `last_run_time` (char[24]): Last program run time

**Usage:**
System-wide configuration and status table. Typically one record per area.

---

### MOVS Structure

**Source:** `movs.h` (lines 24-72)

**Database Table:** `MHC_MOVS`

**Primary Key:** `loadid` (char[7]) + `area` (char[2])

**Key Fields:**
- `loadid` (char[7]): Load identifier
- `area` (char[2]): System area
- `move_status` (char[21]): Current move status (e.g., "PENDING", "IN_PROGRESS", "COMPLETE")
- `move_type` (char[21]): Type of move (e.g., "STORE", "RETRIEVE")
- `initial_location` (char[21]): Starting location
- `final_location` (char[21]): Destination location
- `current_station` (char[21]): Current station
- `next_station` (char[21]): Next station in route
- `vehicle_name` (char[21]): Assigned vehicle
- `priority` (long): Move priority
- `error_code` (long): Error code if move failed

**Usage:**
Tracks load movement requests and their status through the system.

---

### STK Structure

**Source:** `stk.h` (lines 24-101)

**Database Table:** `MHC_SM2DB_STACKER`

**Primary Key:** `devicename` (char[31]) + `area` (char[2])

**Key Fields:**
- `devicename` (char[31]): Stacker crane device name
- `area` (char[2]): System area
- `comm` (long): Communication status
- `hard` (long): Hardware status
- `soft` (long): Software status
- `schedule` (long): Schedule status (Not Busy, Queued, Busy, Error)
- `func` (long): Current function
- `func_ctrl` (long): Control function
- `error_code` (long): Error code
- `enabled` (long): Device enabled flag
- `mode` (long): Operational mode

**Usage:**
Tracks stacker crane device status and properties.

---

### LOAD Structure

**Source:** `load.h` (lines 24-51)

**Database Table:** `MHC_LOAD`

**Primary Key:** `loadid` (char[7]) + `area` (char[2])

**Key Fields:**
- `loadid` (char[7]): Load identifier
- `area` (char[2]): System area
- `load_status` (char[21]): Load status
- `load_type` (char[21]): Type of load
- `location` (char[12]): Current storage location
- `current_station` (char[31]): Current station
- `sr_name` (char[51]): Assigned stacker crane
- `aisle` (long): Aisle number

**Usage:**
Tracks load inventory and current location in the system.

---

## Static Class Wrappers

Each table has a static class wrapper (`db_<TABLE>`) that provides object-oriented access to the functions:

```cpp
static class db_SYS {
public:
    long PR_KEY(SYS *sel, GP_BOOL Update) { return SYS_select_SYS_PR_KEY(sel, Update); }
    long LOOP(SYS *sel, long *count, char *where, GP_BOOL Update) { return SYS_select_LOOP(sel, count, where, Update, 0); }
    // ... other methods
} SYS_;
```

**Usage:**
```cpp
SYS sys;
SYS_init(&sys);
cc_str.copy(sys.area, sizeof(sys.area), "A");

if (SYS_.PR_KEY(&sys, GP_FALSE) == GP.GOOD) {
    // Record found
}
```

---

## Error Handling

All OSUB functions use try-catch blocks to handle ADO COM errors. Errors are processed by `ds_check_error()` which:
- Logs the error
- Handles deadlock conditions
- Returns appropriate return codes (`GP.BAD`, `SQL.HELD`, etc.)

---

## Transaction Management

OSUB functions respect transaction boundaries:
- If `BeginTrans_Level > 0`, functions automatically use pessimistic locking
- Updates and deletes within transactions are automatically rolled back on error
- Use `SQL.start()`, `SQL.commit()`, and `SQL.rollback()` to manage transactions

---

## Date/Time Handling

Date/time fields are stored as strings in the format defined by `DTM_MASK`. Functions automatically convert between:
- Database format (SQL Server datetime)
- Internal format (double)
- Display format (char[24])

Conversion functions used:
- `cs_dtm_internal()`: Converts database date to internal format
- `cs_dtm_fmt()`: Formats internal date to string
- `cs_dtm_current()`: Gets current date/time
- `cs_dtm_put()`: Parses date string

---

## Notes

1. **Thread Safety:** OSUB functions are not thread-safe. Each thread should use its own structure instances.

2. **Recordset Management:** The `RsP` (Recordset Pointer) field in each structure is managed internally. Do not manually manipulate it.

3. **Memory Management:** Structures are stack-allocated. No dynamic memory management required.

4. **String Safety:** All string operations use `cc_str` library functions to prevent buffer overflows.

5. **NULL Handling:** Database NULL values are handled by `Check_DB_Null()` which converts NULLs to appropriate default values (0 for numeric, spaces for strings).

---

## Related Documentation

- Database Reference: See `04_Database_Reference` for table schemas
- CSUB: `csub.md` for common subroutines like `cs_dtm`, `cs_log`
- CCSUB: `ccsub.md` for control classes like `cc_str`

